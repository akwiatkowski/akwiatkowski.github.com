    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const SAMPLE_GALLERY_DATA = {
             galleryName: "{{title}}",
             items: {{json.items}}
        };

        function GalleryApp() {
            const [galleryData, setGalleryData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedIndex, setSelectedIndex] = useState(null);
            const containerRef = useRef(null);

            // Load gallery data - can be from URL or hardcoded
            useEffect(() => {
                const loadGallery = async () => {
                    try {
                        setLoading(true);

                        // Option 1: Fetch from JSON URL
                        // const params = new URLSearchParams(window.location.search);
                        // const jsonUrl = params.get('json');
                        // if (jsonUrl) {
                        //     const response = await fetch(jsonUrl);
                        //     if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        //     const data = await response.json();
                        //     setGalleryData(data);
                        // } else {
                        //     setGalleryData(SAMPLE_GALLERY_DATA);
                        // }

                        // Using hardcoded data by default
                        setGalleryData(SAMPLE_GALLERY_DATA);
                        setError(null);
                    } catch (err) {
                        setError(err.message);
                        setGalleryData(null);
                    } finally {
                        setLoading(false);
                    }
                };

                loadGallery();
            }, []);

            const handleImageClick = (index) => {
                setSelectedIndex(index);
            };

            const handleCloseModal = useCallback(() => {
                setSelectedIndex(null);
            }, []);

            const handlePrevImage = useCallback((e) => {
                e.stopPropagation();
                if (selectedIndex > 0) {
                    setSelectedIndex(selectedIndex - 1);
                }
            }, [selectedIndex]);

            const handleNextImage = useCallback((e) => {
                e.stopPropagation();
                if (selectedIndex < galleryData.items.length - 1) {
                    setSelectedIndex(selectedIndex + 1);
                }
            }, [selectedIndex, galleryData]);

            const handleKeyDown = useCallback((e) => {
                if (selectedIndex === null) return;
                if (e.key === 'Escape') {
                    handleCloseModal();
                } else if (e.key === 'ArrowLeft') {
                    if (selectedIndex > 0) {
                        setSelectedIndex(selectedIndex - 1);
                    }
                } else if (e.key === 'ArrowRight') {
                    if (selectedIndex < galleryData.items.length - 1) {
                        setSelectedIndex(selectedIndex + 1);
                    }
                }
            }, [selectedIndex, galleryData, handleCloseModal]);

            useEffect(() => {
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [handleKeyDown]);

            if (loading) {
                return <div className="loading">Loading gallery...</div>;
            }

            if (error) {
                return <div className="error">Error loading gallery: {error}</div>;
            }

            if (!galleryData || !galleryData.items.length) {
                return <div className="error">No images found in gallery</div>;
            }

            const currentImage = selectedIndex !== null ? galleryData.items[selectedIndex] : null;

            return (
                <div className="gallery-container" ref={containerRef}>
                    <div className="gallery-title">{galleryData.galleryName}</div>

                    <div className="masonry-grid">
                        {galleryData.items.map((item, index) => (
                            <div
                                key={index}
                                className="gallery-item"
                                onClick={() => handleImageClick(index)}
                                role="button"
                                tabIndex={0}
                                aria-label={`View ${item['img.alt']}`}
                            >
                                <img
                                    src={item['img.src']}
                                    alt={item['img.alt']}
                                    title={item['img.title']}
                                    loading="lazy"
                                    onError={(e) => {
                                        e.target.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Crect fill="%23ddd" width="100" height="100"/%3E%3Ctext x="50" y="50" text-anchor="middle" dy=".3em" fill="%23999" font-family="sans-serif" font-size="12"%3EImage%3C/text%3E%3C/svg%3E';
                                    }}
                                />
                                <div className="gallery-overlay">
                                    <div className="gallery-info">
                                        <div className="gallery-info-title">{item['img.title']}</div>
                                        <div className="gallery-info-post-title hidden">{item['post.title']}</div>
                                        <div className="gallery-info-details">
                                            {item['img.time_display']} • {parseFloat(item['img.lat']).toFixed(2)}°, {parseFloat(item['img.lon']).toFixed(2)}°
                                        </div>
                                        <div className="gallery-info-exif">{item['img.exif_string']}</div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {currentImage && (
                        <div
                            className="modal-gallery active"
                            onClick={handleCloseModal}
                        >
                            <div className="modal-content-wrapper" onClick={(e) => e.stopPropagation()}>
                                <button className="modal-close" onClick={handleCloseModal} aria-label="Close modal">
                                    ✕
                                </button>

                                {selectedIndex > 0 && (
                                    <button className="modal-nav prev" onClick={handlePrevImage} aria-label="Previous image">
                                        ‹
                                    </button>
                                )}

                                <img
                                    src={currentImage['img.url']}
                                    alt={currentImage['img.alt']}
                                    className="modal-image"
                                    onError={(e) => {
                                        e.target.alt = 'Image failed to load';
                                    }}
                                />

                                <div className="modal-details">
                                    <h3>{currentImage['post.title']}</h3>
                                    <p>
                                        <strong>Date:</strong> {currentImage['img.time_display']}<br/>
                                        <strong>Location:</strong> {parseFloat(currentImage['img.lat']).toFixed(4)}°N, {parseFloat(currentImage['img.lon']).toFixed(4)}°E<br/>
                                        <strong>Altitude:</strong> {currentImage['img.altitude']} m
                                    </p>
                                    <div className="modal-details-exif">
                                        <strong>Camera:</strong><br/>
                                        {currentImage['img.exif_string']}
                                    </div>
                                </div>

                                {selectedIndex < galleryData.items.length - 1 && (
                                    <button className="modal-nav next" onClick={handleNextImage} aria-label="Next image">
                                        ›
                                    </button>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GalleryApp />);
    </script>
</body>
</html>
